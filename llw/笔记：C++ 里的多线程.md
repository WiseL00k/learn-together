---
tags:
  - type/concept
  - topic/cpp
  - status/wip
date: 2026-01-10
---
> 通过多线程编程，开发者可以将任务拆分为多个线程，利用现代 CPU 的性能并行执行。
> 线程安全 (mutex) 相关，需另见新文章

# 1. 概念
## 1.1 线程和进程

进程（Process）是操作系统分配资源的基本单位，而线程（Thread）是操作系统调度的基本单位。

| **特性**   | **进程 (Process)**           | **线程 (Thread)**                  |
| -------- | -------------------------- | -------------------------------- |
| **定义**   | 一个正在运行的程序的实例。              | 进程中的一个执行路径，是更小的执行单元。             |
| **资源拥有** | 拥有独立的内存空间（堆、栈、代码段）和系统资源。   | 共享所属进程的资源（如内存、打开的文件），但有自己的栈和寄存器。 |
| **独立性**  | 进程之间相互独立，一个进程崩溃通常不会影响其他进程。 | 线程间相互影响，一个线程崩溃可能导致整个进程崩溃。        |
| **开销**   | 创建、销毁和切换（上下文切换）的开销很大。      | 创建和切换非常轻量，开销远小于进程。               |
| **通信**   | 进程间通信（IPC）较复杂（如管道、信号、套接字）。 | 同一进程内的线程共享内存，通信非常简单、快速。          |
> 对于操作系统来说，一个任务就是一个进程（Process），比如打开一个浏览器就是启动一个浏览器进程，打开一个记事本就启动了一个记事本进程，打开两个记事本就启动了两个记事本进程，打开一个Word就启动了一个Word进程。
> 有些进程还不止同时干一件事，比如Word，它可以同时进行打字、拼写检查、打印等事情。在一个进程内部，要同时干多件事，就需要同时运行多个“子任务”，我们把进程内的这些“子任务”称为线程（Thread）。
## 1.2 什么时候需要多线程

- **高并发处理**
当系统需要处理大量的用户请求时，多线程可以有效地提高并发处理能力。例如，Web服务器在处理多个用户请求时，可以为每个请求分配一个线程，从而实现高并发处理。

- **后台处理大任务**
在程序执行过程中，如果遇到需要花费大量时间处理的任务，可以将这些任务放到后台线程中处理。这样，主程序可以继续执行，用户无需等待。例如，文件下载、数据处理等。

- **并行计算**
对于需要进行大量计算的任务，可以使用多线程来并行处理，从而加快计算速度。例如，图像处理、科学计算等。

- **等待I/O操作**
在等待网络、文件系统、用户输入等I/O操作时，可以使用多线程来避免阻塞主程序。例如，网络请求、文件读写等。

在 rm_control 里，校准控制器的切换需要发送大量的请求（常规控制器的停止、校准控制器的启动），故而采用多线程设计，实现异步非阻塞的服务调用。

# 2. C++ 中的多线程

C++11提供了语言层面上的多线程，包含在头文件 `<thread>` 中

## 2 .1 创建进程

创建进程只需要将函数添加到进程当中即可。例如下列程序：

```cpp
#include <iostream>
#include <thread>

void output()
{
  std::cout << "Hello,world" << std::endl;
}
int main()
{
  std::thread output_thread(output);
  return 0;
}
```

如果函数需要传入参数，则格式类似 `std::thread my_thread(func, var1, var2...)`
即函数和参数分开传递。
> [!IMPORTANT] **注意引用传递：** 如果你想通过引用传递参数（让子线程修改主线程的变量），必须使用 `std::ref`，例如：`std::thread t(func, std::ref(myVar));`。否则，C++ 默认会进行拷贝。

## 2 .2 线程的管理

线程被创建后，立刻就开始运行了。我们可以通过 `join` 方法管理线程执行的顺序，也可以通过 `detach` 方法表明线程就此和主线程分离，执行完成后释放资源。
需要注意的是，我们一定要声明所创建的进程后续的处理方式，否则可能出现主线程在子线程之前结束并释放资源的情况。

`join` 和 `detach` 的区别如下：
![[images/Pasted image 20251225111015 1.png]]